name: CI/CD Pipeline - Ivanov

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    env:
      TELEGRAM_CHAT_ID: "–í–ê–®_CHAT_ID"
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install black pytest pytest-html

    - name: Run tests
      run: |
        pytest --html=test-report.html --self-contained-html

    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.html

    # –°–ü–û–°–û–ë 1: –ß–µ—Ä–µ–∑ –≥–æ—Ç–æ–≤—ã–π Action
    - name: Send Telegram success (Action)
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ env.TELEGRAM_CHAT_ID }}
        token: ${{ env.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚úÖ CI/CD –£–°–ü–ï–®–ù–û
          
          üì¶ ${{ github.repository }}
          üéØ ${{ github.ref_name }}
          üë§ ${{ github.actor }}
          
          üîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    # –°–ü–û–°–û–ë 2: –ß–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π API (–∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π)
    - name: Send Telegram fallback
      if: success()
      run: |
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        MESSAGE="üîÑ Pipeline completed
        
        üìä *Repository:* ${{ github.repository }}
        üéØ *Branch:* ${{ github.ref_name }}
        üë§ *Author:* ${{ github.actor }}
        ‚úÖ *Status:* SUCCESS
        
        üìé [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ API
        curl -s -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
          -d "text=$MESSAGE" \
          -d "parse_mode=Markdown" \
          --output /tmp/telegram_response.txt
        
        echo "üì® –û—Ç–≤–µ—Ç –æ—Ç Telegram API:"
        cat /tmp/telegram_response.txt