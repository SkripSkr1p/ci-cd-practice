name: CI/CD Pipeline - Ivanov

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  
env:
  TELEGRAM_CHAT_ID: "–í–ê–®_CHAT_ID"
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pytest pytest-html

    # 1. –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ê–í–¢–û–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï
    - name: Auto-format code with Black
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
        black .
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è - –∫–æ–º–º–∏—Ç–∏–º
        if ! git diff --quiet; then
          echo "üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "üîß Auto-format code with Black [skip ci]"
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
        else
          echo "‚úÖ –ö–æ–¥ —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
        fi

    - name: Check code format with black
      run: |
        black --check .

    - name: Run linter (flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run tests with pytest
      run: |
        pytest test_app.py test_advanced.py -v --html=test-report.html --self-contained-html

    - name: Upload test report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.html
        retention-days: 30

    - name: Run original script
      run: python main.py

    # 2. TELEGRAM –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    - name: Send Telegram notification on success
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ env.TELEGRAM_CHAT_ID }}
        token: ${{ env.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚úÖ CI/CD Pipeline –£–°–ü–ï–®–ù–û –≤—ã–ø–æ–ª–Ω–µ–Ω!
          
          üìä –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üéØ –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          
          üß™ –¢–µ—Å—Ç—ã: –ü—Ä–æ–π–¥–µ–Ω—ã
          üìù –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
          üîç Linter: –ü—Ä–æ–≤–µ—Ä–µ–Ω
          
          üì• –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ GitHub Actions
          
          üîó –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Send Telegram notification on failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ env.TELEGRAM_CHAT_ID }}
        token: ${{ env.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚ùå CI/CD Pipeline –ó–ê–í–ï–†–®–ò–õ–°–Ø –° –û–®–ò–ë–ö–û–ô!
          
          üìä –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üéØ –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          
          ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
          - –û—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Black)
          - –ü—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ç–∏–ª–µ–º –∫–æ–¥–∞ (flake8)
          - –ü–∞–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ (pytest)
          
          üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
          üîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          üõ†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞!