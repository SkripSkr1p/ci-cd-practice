name: CI/CD Pipeline - Makarenko  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  
env:
  TELEGRAM_CHAT_ID: "800338121"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à ID
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pytest pytest-html

    # 1. –ê–í–¢–û–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–î–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è push –≤ main)
    - name: Auto-format code with Black (push only)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "Running auto-formatting..."
        black . --check
        if [ $? -ne 0 ]; then
          echo "Code needs formatting. Running black..."
          black .
          echo "Committing formatted code..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-format code with Black [skip ci]" || echo "No changes to commit"
          git push origin main || echo "No changes to push"
        else
          echo "Code is already formatted correctly."
        fi

    - name: Run linter (flake8)
      run: |
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # –û–±—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Check code format with black
      run: |
        black --check .

    # 2. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –û–¢–ß–ï–¢–ê
    - name: Run tests with pytest
      run: |
        pytest test_app.py -v --html=test-report.html --self-contained-html

    # 3. –°–û–•–†–ê–ù–ï–ù–ò–ï –ê–†–¢–ï–§–ê–ö–¢–û–í
    - name: Upload test report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.html
        retention-days: 30

    - name: Run original script
      run: python main.py

    # 4. –û–¢–ü–†–ê–í–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –í TELEGRAM
    - name: Send Telegram notification on success
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ env.TELEGRAM_CHAT_ID }}
        token: ${{ env.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚úÖ CI/CD Pipeline –£–°–ü–ï–®–ù–û –≤—ã–ø–æ–ª–Ω–µ–Ω!
          
          üìä –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üéØ –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          üìÖ –í—Ä–µ–º—è: ${{ github.event.head_commit.timestamp }}
          
          üìù –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}
          
          üîó –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! üéâ

    - name: Send Telegram notification on failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ env.TELEGRAM_CHAT_ID }}
        token: ${{ env.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚ùå CI/CD Pipeline –ó–ê–í–ï–†–®–ò–õ–°–Ø –° –û–®–ò–ë–ö–û–ô!
          
          üìä –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üéØ –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          
          ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:
          üîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞!